#!/usr/bin/env node
/**
 * Generates Cloudflare Pages _redirects with 200 rewrites for default locale.
 * Run after next build. Reads dist/en/ and writes dist/_redirects.txt.
 */

import { readdirSync, writeFileSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const distDir = join(__dirname, "..", "dist");
const defaultLocale = "en";
const enDir = join(distDir, defaultLocale);

const lines = [
  "# Default locale rewrites (200 = serve content without redirect)",
  "# Generated by scripts/generate-redirects.mjs",
  "/ /en 200",
];

try {
  const entries = readdirSync(enDir, { withFileTypes: true });
  for (const entry of entries) {
    if (entry.isFile() && entry.name.endsWith(".html")) {
      const base = entry.name.replace(/\.html$/, "");
      lines.push(`/${base} /en/${base} 200`);
    }
  }
  const output = join(distDir, "_redirects.txt");
  writeFileSync(output, lines.join("\n") + "\n", "utf8");
  console.log(`Generated ${output} with ${lines.length - 3} page rules`);
} catch (err) {
  console.error("generate-redirects:", err.message);
  process.exit(1);
}
